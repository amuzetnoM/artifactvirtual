#!/bin/bash

set -e
ROOT_DIR=/workspaces/codespaces-models

echo "[+] Bootstrapping ArtifactVirtual..."

# -----------------------------------
# Node.js Dependencies
# -----------------------------------
if [ -f "$ROOT_DIR/package.json" ]; then
  echo "[Node] Installing packages..."
  npm install --prefix "$ROOT_DIR"
fi

# -----------------------------------
# Python Dependencies
# -----------------------------------
if [ -f "$ROOT_DIR/requirements.txt" ]; then
  echo "[Python] Installing packages..."
  pip install --upgrade pip
  pip install -r "$ROOT_DIR/requirements.txt"
fi

# -----------------------------------
# PostgreSQL Check + Init
# -----------------------------------
echo "[DB] Checking PostgreSQL availability..."
until pg_isready -h postgres -p 5432 -U artifact >/dev/null 2>&1; do
  echo "[DB] Waiting for PostgreSQL to become available..."
  sleep 2
done

echo "[DB] Connected. Verifying database..."
DB_EXIST=$(psql -U artifact -h postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'artifactdb';" | grep -q 1 && echo yes || echo no)

if [ "$DB_EXIST" = "no" ]; then
  echo "[DB] Creating database artifactdb..."
  psql -U artifact -h postgres -c "CREATE DATABASE artifactdb;"
else
  echo "[DB] Database already exists."
fi

# -----------------------------------
# Export ENV Vars (optional .env loader)
# -----------------------------------
ENV_FILE="$ROOT_DIR/.env"
if [ -f "$ENV_FILE" ]; then
  echo "[Env] Loading environment variables..."
  export $(grep -v '^#' "$ENV_FILE" | xargs)
fi

echo "[+] Bootstrap complete."
